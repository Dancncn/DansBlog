---
import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import Header from '../components/Header.astro';
import MobileDrawer from '../components/MobileDrawer.astro';
import TocSidebar from '../components/TocSidebar.astro';
import TocDrawer from '../components/TocDrawer.astro';

type Props = CollectionEntry<'blog'>['data'] & {
	profileImage?: string;
	headings?: { depth: number; slug: string; text: string }[];
};

const { title, description, pubDate, updatedDate, heroImage, profileImage, tags = [], headings = [] } = Astro.props;

const BASE = import.meta.env.BASE_URL;
const withBase = (path: string) => {
	if (!path) return path;
	if (path.startsWith('http://') || path.startsWith('https://')) return path;
	if (path.startsWith(BASE)) return path;
	return `${BASE}${path.replace(/^\/+/, '')}`;
};

const tocItems = headings.filter((h) => h.depth === 2 || h.depth === 3 || h.depth === 4);
const hasToc = tocItems.length > 0;
---

<html lang="en">
	<head>
		<BaseHead title={title} description={description} />
	</head>
	<body>
		<Header showTocButton={hasToc} />
		<MobileDrawer />

		<div class="page-shell py-10 md:py-14" transition:name="page-main" transition:animate="fade">
			<div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
				<div class="mt-10 md:grid md:grid-cols-[240px_minmax(0,1fr)] md:items-start md:gap-10">
					{hasToc && (
						<aside class="hidden md:block md:self-stretch">
							<div class="sticky top-24 max-h-[calc(100vh-7rem)] overflow-auto pr-2" data-toc-scroll="sidebar">
								<TocSidebar headings={tocItems} />
							</div>
						</aside>
					)}

					<main class:list={['min-w-0', !hasToc && 'md:col-span-2 md:col-start-1']}>
						<header class="mb-10 border-b border-zinc-200 pb-6 dark:border-zinc-700">
							<p class="m-0 text-sm text-zinc-500 dark:text-zinc-400">
								<FormattedDate date={pubDate} />
								{updatedDate && (
									<span class="ml-3 inline-block italic">
										Updated <FormattedDate date={updatedDate} />
									</span>
								)}
							</p>

							<div class="mt-3 flex items-start justify-between gap-4">
								<h1
									class="text-3xl font-semibold tracking-tight text-zinc-900 dark:text-zinc-100 md:text-4xl"
									transition:name="page-title"
									transition:animate="fade"
								>
									{title}
								</h1>

								{profileImage && (
									<img
										src={withBase(profileImage)}
										alt={`${title} profile`}
										class="h-14 w-14 shrink-0 rounded-full border border-zinc-200 object-cover dark:border-zinc-700 md:h-16 md:w-16"
										loading="lazy"
									/>
								)}
							</div>

							<p class="mt-3 font-serif text-zinc-600 dark:text-zinc-300">{description}</p>

							{tags.length > 0 && (
								<div class="mt-4 flex flex-wrap gap-2">
									{tags.map((tag) => (
										<a
											href={`${BASE}tags/${encodeURIComponent(tag)}/`}
											class="rounded-lg border border-zinc-200 px-2.5 py-1 text-xs font-medium text-zinc-600 no-underline transition-colors hover:border-zinc-300 hover:text-zinc-900 dark:border-zinc-700 dark:text-zinc-300 dark:hover:border-zinc-500 dark:hover:text-zinc-100"
										>
											#{tag}
										</a>
									))}
								</div>
							)}
						</header>

						<article class="section-enter w-full max-w-none">
							{heroImage && (
								<div class="mb-8 overflow-hidden rounded-2xl border border-zinc-200 bg-white dark:border-zinc-700 dark:bg-zinc-900">
									{typeof heroImage === 'string' ? (
										<img src={withBase(heroImage)} alt={title} class="h-auto w-full" loading="lazy" />
									) : (
										<Image width={1200} height={620} src={heroImage} alt="" class="h-auto w-full" />
									)}
								</div>
							)}

							<div class="markdown-prose">
								<slot />
							</div>
						</article>

						<TocDrawer headings={tocItems} />
					</main>
				</div>
			</div>
		</div>

		<Footer />

		<style is:global>
			.markdown-prose :is(h2, h3, h4) {
				scroll-margin-top: 7rem;
			}
		</style>

		<script is:inline>
			const scrollToTopIfNoHash = () => {
				try {
					if ('scrollRestoration' in history) history.scrollRestoration = 'manual';
				} catch {}
				if (!window.location.hash) {
					requestAnimationFrame(() => requestAnimationFrame(() => window.scrollTo(0, 0)));
				}
			};

			const initTocActiveState = () => {
				if (typeof window.__tocCleanup === 'function') {
					window.__tocCleanup();
					window.__tocCleanup = null;
				}

				const links = Array.from(document.querySelectorAll('[data-toc-link]'));
				const headings = Array.from(
					document.querySelectorAll('.markdown-prose h2[id], .markdown-prose h3[id], .markdown-prose h4[id]')
				);

				if (links.length === 0 || headings.length === 0) return;

				const ACTIVE_CLASSES = [
					'bg-zinc-100/70',
					'text-zinc-900',
					'border-zinc-900/60',
					'dark:bg-zinc-800/60',
					'dark:text-zinc-100',
					'dark:border-zinc-200/70',
				];

				const linkMap = new Map();
				for (const link of links) {
					const id = link.dataset.tocLink || '';
					if (!id) continue;
					const group = linkMap.get(id) || [];
					group.push(link);
					linkMap.set(id, group);
				}

				const clearActive = () => {
					for (const link of links) {
						link.classList.remove(...ACTIVE_CLASSES);
						link.removeAttribute('aria-current');
					}
				};

				const ensureVisibleInToc = (link) => {
					const container = link.closest('[data-toc-scroll]');
					if (!container) return;
					const cRect = container.getBoundingClientRect();
					const eRect = link.getBoundingClientRect();
					if (eRect.top < cRect.top || eRect.bottom > cRect.bottom) {
						link.scrollIntoView({ block: 'nearest' });
					}
				};

				const setActive = (id) => {
					clearActive();
					if (!id) return;
					const group = linkMap.get(id) || [];
					for (const link of group) {
						link.classList.add(...ACTIVE_CLASSES);
						link.setAttribute('aria-current', 'true');
						ensureVisibleInToc(link);
					}
				};

				const getActiveIdByScroll = () => {
					let current = headings[0]?.id || '';
					for (const heading of headings) {
						if (heading.getBoundingClientRect().top <= 140) current = heading.id;
					}
					return current;
				};

				let rafId = 0;
				const scheduleApply = () => {
					if (rafId) cancelAnimationFrame(rafId);
					rafId = requestAnimationFrame(() => {
						setActive(getActiveIdByScroll());
					});
				};

				const onHashChange = () => {
					const id = decodeURIComponent(window.location.hash.replace(/^#/, ''));
					if (id && linkMap.has(id)) {
						setActive(id);
					} else {
						scheduleApply();
					}
				};

				window.addEventListener('scroll', scheduleApply, { passive: true });
				window.addEventListener('resize', scheduleApply);
				window.addEventListener('hashchange', onHashChange);

				const hashId = decodeURIComponent(window.location.hash.replace(/^#/, ''));
				if (hashId && linkMap.has(hashId)) {
					setActive(hashId);
				} else {
					scheduleApply();
				}

				window.__tocCleanup = () => {
					if (rafId) cancelAnimationFrame(rafId);
					window.removeEventListener('scroll', scheduleApply);
					window.removeEventListener('resize', scheduleApply);
					window.removeEventListener('hashchange', onHashChange);
				};
			};

			const onPostPageLoad = () => {
				scrollToTopIfNoHash();
				initTocActiveState();
			};

			onPostPageLoad();
			if (!window.__blogPostEventsBound) {
				document.addEventListener('astro:page-load', onPostPageLoad);
				document.addEventListener('astro:after-swap', onPostPageLoad);
				window.__blogPostEventsBound = true;
			}
		</script>
	</body>
</html>